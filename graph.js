var JsonAttuale = {
    "relExtEdges": [
        {
            "id": "R0",
            "srcID": "E3",
            "destID": "E4",
            "label": "HA_RAPPORTO_CON"
        },
        {
            "id": "R1",
            "srcID": "E3",
            "destID": "E5",
            "label": "HA_RAPPORTO_CON"
        },
        {
            "id": "R2",
            "srcID": "E3",
            "destID": "E6",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R3",
            "srcID": "E4",
            "destID": "E3",
            "label": "HA_RAPPORTO_CON"
        },
        {
            "id": "R4",
            "srcID": "E4",
            "destID": "E5",
            "label": "HA_RAPPORTO_CON"
        },
        {
            "id": "R5",
            "srcID": "E4",
            "destID": "E6",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R6",
            "srcID": "E5",
            "destID": "E3",
            "label": "HA_RAPPORTO_CON"
        },
        {
            "id": "R7",
            "srcID": "E5",
            "destID": "E4",
            "label": "HA_RAPPORTO_CON"
        },
        {
            "id": "R8",
            "srcID": "E5",
            "destID": "E6",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R9",
            "srcID": "E3",
            "destID": "E7",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R10",
            "srcID": "E5",
            "destID": "E7",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R11",
            "srcID": "E5",
            "destID": "E11",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R12",
            "srcID": "E5",
            "destID": "E12",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R13",
            "srcID": "E5",
            "destID": "E13",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R14",
            "srcID": "E5",
            "destID": "E14",
            "label": "FREQUENTA_LUOGO"
        },
        {
            "id": "R15",
            "srcID": "E5",
            "destID": "E15",
            "label": "FREQUENTA_LUOGO"
        }
    ],
    "relExtVertices": [
        {
            "id": "E0",
            "type": "Luogo",
            "label": "CAPOLINEA DELLA STAZIONE TERMINI",
            "url": "#",
            "tooltip": "CAPOLINEA DELLA STAZIONE TERMINI",
            "relExtCitationIndices": [
                {
                    "start": 49,
                    "end": 81
                }
            ]
        },
        {
            "id": "E1",
            "type": "Soggetto Fisico",
            "label": "PERSONE",
            "url": "#",
            "tooltip": "PERSONE",
            "relExtCitationIndices": [
                {
                    "start": 138,
                    "end": 145
                }
            ]
        },
        {
            "id": "E2",
            "type": "Soggetto Fisico",
            "label": "EGBENOMA JASSICAT",
            "url": "#",
            "tooltip": "EGBENOMA JASSICAT",
            "relExtCitationIndices": [
                {
                    "start": 154,
                    "end": 171
                }
            ]
        },
        {
            "id": "E3",
            "type": "Soggetto Fisico",
            "label": "UWUHAROGIE OSAMEDE KELLY",
            "url": "#",
            "tooltip": "UWUHAROGIE OSAMEDE KELLY",
            "relExtCitationIndices": [
                {
                    "start": 221,
                    "end": 245
                },
                {
                    "start": 355,
                    "end": 379
                }
            ]
        },
        {
            "id": "E4",
            "type": "Soggetto Fisico",
            "label": "DONNA",
            "url": "#",
            "tooltip": "DONNA",
            "relExtCitationIndices": [
                {
                    "start": 251,
                    "end": 256
                }
            ]
        },
        {
            "id": "E5",
            "type": "Soggetto Fisico",
            "label": "YANKEE IKECHUKU",
            "url": "#",
            "tooltip": "YANKEE IKECHUKU",
            "relExtCitationIndices": [
                {
                    "start": 268,
                    "end": 283
                },
                {
                    "start": 401,
                    "end": 416
                },
                {
                    "start": 714,
                    "end": 729
                },
                {
                    "start": 1049,
                    "end": 1064
                },
                {
                    "start": 1182,
                    "end": 1197
                }
            ]
        },
        {
            "id": "E6",
            "type": "Luogo",
            "label": "VIA GIOACCHINO RUSSO",
            "url": "#",
            "tooltip": "VIA GIOACCHINO RUSSO",
            "relExtCitationIndices": [
                {
                    "start": 302,
                    "end": 322
                }
            ]
        },
        {
            "id": "E7",
            "type": "Luogo",
            "label": "STAZIONE FERROVIARIA ROMA TIBURTINA",
            "url": "#",
            "tooltip": "STAZIONE FERROVIARIA ROMA TIBURTINA",
            "relExtCitationIndices": [
                {
                    "start": 518,
                    "end": 553
                }
            ]
        },
        {
            "id": "E8",
            "type": "Luogo",
            "label": "STAZIONE",
            "url": "#",
            "tooltip": "STAZIONE",
            "relExtCitationIndices": [
                {
                    "start": 584,
                    "end": 592
                }
            ]
        },
        {
            "id": "E9",
            "type": "Luogo",
            "label": "UDINE",
            "url": "#",
            "tooltip": "UDINE",
            "relExtCitationIndices": [
                {
                    "start": 654,
                    "end": 659
                }
            ]
        },
        {
            "id": "E10",
            "type": "Soggetto Fisico",
            "label": "' JENNIFER'",
            "url": "#",
            "tooltip": "' JENNIFER'",
            "relExtCitationIndices": [
                {
                    "start": 735,
                    "end": 745
                }
            ]
        },
        {
            "id": "E11",
            "type": "Luogo",
            "label": "CAPOLINEA DELLA STAZIONE AUTOBUS ' GROTTE CELONI'",
            "url": "#",
            "tooltip": "CAPOLINEA DELLA STAZIONE AUTOBUS ' GROTTE CELONI'",
            "relExtCitationIndices": [
                {
                    "start": 999,
                    "end": 1047
                }
            ]
        },
        {
            "id": "E12",
            "type": "Luogo",
            "label": "TERMINI",
            "url": "#",
            "tooltip": "TERMINI",
            "relExtCitationIndices": [
                {
                    "start": 1107,
                    "end": 1114
                }
            ]
        },
        {
            "id": "E13",
            "type": "Luogo",
            "label": "LOCALITÀ PONTE DI NONA",
            "url": "#",
            "tooltip": "LOCALITÀ PONTE DI NONA",
            "relExtCitationIndices": [
                {
                    "start": 1236,
                    "end": 1258
                }
            ]
        },
        {
            "id": "E14",
            "type": "Luogo",
            "label": "VIA FRANCESCO CALTAGIRONE",
            "url": "#",
            "tooltip": "VIA FRANCESCO CALTAGIRONE",
            "relExtCitationIndices": [
                {
                    "start": 1276,
                    "end": 1301
                }
            ]
        },
        {
            "id": "E15",
            "type": "Luogo",
            "label": "ABITAZIONE DI UWUHAROGIE OSAMEDE KELLY",
            "url": "#",
            "tooltip": "ABITAZIONE DI UWUHAROGIE OSAMEDE KELLY",
            "relExtCitationIndices": [
                {
                    "start": 1321,
                    "end": 1359
                }
            ]
        }
    ],
    "inputText": "- alle ore 22.40 , l' autobus giungeva presso il capolinea della Stazione Termini. L' autobus si fermava e dallo stesso scendevano alcune persone tra cui EGBENOMA Jassicat con il trolley di colore blu; - alle ore 21.25 , UWUHAROGIE Osamede Kelly e la donna salutavano YANKEE Ikechuku allontanandosi su via Gioacchino Russo , in direzione della vettura di UWUHAROGIE Osamede Kelly. In questo frangente YANKEE Ikechuku si allontanava salendo a bordo dell' autobus con il quale, dopo vari cambi giungeva nei pressi della Stazione Ferroviaria Roma Tiburtina. Una volta all' interno della stazione saliva a bordo del treno Intercity delle ore 22,36 diretto a Udine. Nell' occasione non venivano effettuati controlli su YANKEE Ikechuku e su 'JENNIFER', in quanto, sia dal servizio dinamico, sia dalle intercettazioni telefoniche, appariva chiaro che non era avvenuta alcuna cessione di stupefacenti. (Allegato 28 : annotazione d' attività d' inda gine del 17 novembre 2010 ); - alle ore 16.40 , presso il capolinea della Stazione Autobus 'Grotte Celoni', YANKEE Ikechuku scendeva dall' autobus 105 proveniente da Termini, con al seguito un borsone Trolley di colore nero. Successivamente YANKEE Ikechuku, mediante altri autobus, si recava in località Ponte di Nona, precisamente in via Francesco Caltagirone , nei pressi dell' abitazione di UWUHAROGIE Osamede Kelly, permanendo in evidente stato di attesa."
};

jQuery('#legenda_menu').click(function () {
    jQuery('.legenda_hidden').slideToggle(400);
    jQuery(this).toggleClass('open');
});
jQuery('#back_btn').click(function () {
    var back_url = History.getState();
    var link_focus = back_url.data['link_old'];
    jQuery('.loader').fadeIn(0);
    jQuery('#cy2 canvas').fadeOut(0);
    setTimeout(function () {
        create_json(link_focus);
        History.back();
    }, 300);

});


var cy = null;
var scalingFactor = 200;
var inputText;
var textDim;

var citAttuale = 0;
var citAttualeArray = "";
var citTypeAttyale = "";

var urlPrefixNodeMenu = '';
var array_menu_creati = new Array();
var array_nodi_espansi = new Array();

(function ($) {


    $(document).ready(function () {
        load(JsonAttuale);

        document.forms['myform'].elements['myfile'].onchange = function (evt) {
            if (!window.FileReader) return; // Browser is not compatible

            var reader = new FileReader();

            reader.onload = function (evt) {
                if (evt.target.readyState != 2) return;
                if (evt.target.error) {
                    alert('Error while reading file');
                    return;
                }

                filecontent = evt.target.result;
                JsonAttuale = JSON.parse(evt.target.result);

                load(JsonAttuale);
            };

            reader.readAsText(evt.target.files[0]);
        };

    });

})(jQuery);



function createAppendNode(id, label, tooltip, type, nodeset, sito, citations) {

    nodeset.push({
        "nodeHint": null,
        "nodeID": id,
        "nodeLabel": {
            "label": label,
            "tooltip": tooltip
        },
        "nodeMenu": {
            "options": {
                "option": [

                    {
                        "label": "Link Site",
                        "target": "_blank",
                        "url": sito,
                        "callback": "open_link"
                    },
                    {
                        "label": "Show Citation",
                        "target": "_blank",
                        "citations": citations,
                        "callback": "show_citations"
                    }

                ]
            }
        },
        "nodeType": type
    });
}

function createAppendEdge(id, label, tooltip, source, destination, length, edgeset) {

    edgeset.push({
        "direction": true,
        "edgeID": "e0" + id,
        "edgeLabel": {
            "label": label,
            "tooltip": tooltip
        },
        "edgeMenu": {
            "options": {
                "option": [

                    {
                        "label": "Focus",
                        "target": "_blank",
                        "url": "http://localhost:8080/graph-html5/rest/graphdata",
                        "callback": "replace_graph"
                    }

                ]
            }
        },
        "fromID": source,
        "length": length,
        "toID": destination,
        "visible": true
    });
}

function load(json) {

    if (cy) {
        cy = null;
        array_menu_creati = new Array();
        inputText = null;
        document.getElementById("textDiv").innerHTML = "";
    }
    var nuovoJson = {};
    nuovoJson.nodeset = {};
    nuovoJson.nodeset.node = [];
    nuovoJson.edgeset = {};
    nuovoJson.edgeset.edge = [];

    inputText = json.inputText;
    textDim = inputText.length;
    document.getElementById("textDiv").innerHTML = inputText;

    for (var z = 0; z < json.relExtVertices.length; z++) {

        var id = json.relExtVertices[z].id;
        var type = json.relExtVertices[z].type;
        var label = json.relExtVertices[z].label;
        var url = json.relExtVertices[z].url;
        var tooltip = json.relExtVertices[z].tooltip;
        var citations = json.relExtVertices[z].relExtCitationIndices;

        createAppendNode(id, label, tooltip, type, nuovoJson.nodeset.node, url, citations);
    }

    for (var e = 0; e < json.relExtEdges.length; e++) {

        var id = json.relExtEdges[e].id;
        var srcID = json.relExtEdges[e].srcID;
        var destID = json.relExtEdges[e].destID;
        var label = json.relExtEdges[e].label;

        createAppendEdge(id, label, label, srcID, destID, 50.0, nuovoJson.edgeset.edge);
    }


    var tuttoString2 = JSON.stringify(nuovoJson);
    var obj2 = JSON.parse(tuttoString2);
    var nodiFinali = obj2.nodeset.node;
    var archiFinali = obj2.edgeset.edge;

    create_json(nodiFinali, archiFinali);
}


/* Funzione per creare un grafico da 0*/
function create_json(NoDi, ArChI) {

    var nodi = NoDi;
    var archi = ArChI;

    var arrayNodi = new Array();
    var arrayNodi = {
        nodes: [],
        edges: []
    };

    jQuery.each(nodi, function (key, value) {

        var open_temp = 'false',
            open_temp_name = '',
            open_temp_url = '',

            citations_temp = 'false',
            citations_temp_label = '',
            citations_temp_array = '';

        var lunghezza_menu = value['nodeMenu']['options']['option'].length;

        for (var i = 0; i < lunghezza_menu; i++) {

            var quale_menu = value['nodeMenu']['options']['option'][i]['callback'];
            var url_menu = value['nodeMenu']['options']['option'][i]['url'];
            var citations_menu = value['nodeMenu']['options']['option'][i]['citations'];

            if (url_menu != null) {
                open_temp = 'true';
                open_temp_name = value['nodeMenu']['options']['option'][i]['label'];
                open_temp_url = value['nodeMenu']['options']['option'][i]['url'];
            } else if (citations_menu != null) {
                citations_temp = 'true',
                    citations_temp_label = value['nodeMenu']['options']['option'][i]['label'];
                citations_temp_array = value['nodeMenu']['options']['option'][i]['citations'];
            }
        }

        arrayNodi.nodes.push({
            'id_select': value['nodeID'],
            'data': {
                'id': value['nodeID'],
                'content': "link",

                'open': open_temp,
                'open_name': open_temp_name,
                'open_url': open_temp_url,

                'citation': citations_temp,
                'citation_label': citations_temp_label,
                'citattion_array': citations_temp_array,

                'hint': value['hint'],
                'nodeType': value['nodeType'],
                'label': value.nodeLabel['label'],
                'tooltip': value.nodeLabel['tooltip']
            }
        });
    });

    jQuery.each(archi, function (key, value) {
        var open_temp = 'false',
            open_temp_url = '';
        var lunghezza_menu = value['edgeMenu']['options']['option'].length;
        for (var i = 0; i < lunghezza_menu; i++) {
            var quale_menu = value['edgeMenu']['options']['option'][i]['callback'];
            if (quale_menu == 'open_link') {
                open_temp = 'true';
                open_temp_url = value['edgeMenu']['options']['option'][i]['url'];
            }
        }
        arrayNodi.edges.push({
            'id_select': value['edgeID'],
            'length': value['length'] / scalingFactor,
            'data': {
                'id': value['edgeID'],
                'open': open_temp,
                'open_url': open_temp_url,
                'length': value['length'] / scalingFactor,
                'source': value['fromID'],
                'target': value['toID'],
                'label': value.edgeLabel['label']
            }
        });
    });

    inizializeGraph(arrayNodi);
}

function inizializeGraph(elesJson) {

    cy = cytoscape({
        container: document.getElementById('cy2'),
        style: cytoscape.stylesheet()
            .selector('node')
            .css({
                'width': '270',
                'height': '70',
                'font-weight': 'bold',
                'content': 'data(label)',
                'background-position-x': '-20px',
                'color': '#353535',
                'shape': 'roundrectangle',
                'text-max-width': '170px',
                'font-size': '22px',
                'padding': '30px',
                'text-valign': 'center',
                'text-halign': 'center',
                'text-wrap': 'wrap',
                'background-opacity': 1,
                'border-opacity': 1,
                'border-width': 2,
                'border-style': 'solid',
            })
            .selector('edge')
            .css({
                'curve-style': 'bezier',
                'content': 'data(label)',
                'line-color': '#9b9b9b',
                'font-size': '21px',
                'control-point-distance': 'data(length)',
                'target-arrow-color': '#9b9b9b',
                'target-arrow-shape': 'triangle',
                'opacity': 0.8
            })
            .selector(':selected')
            .css({
                'background-color': '#fff',
                'line-color': 'black',
                'target-arrow-color': 'black',
                'source-arrow-color': 'black',
                'opacity': 1
            })
            .selector('.not_selected')
            .css({
                'opacity': 0.3,
                'text-opacity': 0,
                'background-image': 'css/img/none.svg',
            })
            .selector('.expanded')
            .css({
                'background-color': '#a2f4a3',
            })
            .selector('.eating')
            .css({
                'border-color': 'red'
            }).selector('node[nodeType = "Luogo"]').css({
                'width': '100',
                'height': '100',
                'text-valign': 'bottom',
                'shape': 'ellipse',
                'background-position-x': '50%',
                'background-color': 'white',
                'border-color': '#3e7794',
                'background-image': 'images/place100.png',
            }).selector('node[nodeType = "Soggetto Fisico"]').css({
                'width': '100',
                'height': '100',
                'text-valign': 'bottom',
                'shape': 'ellipse',
                'background-position-x': '50%',
                'background-color': 'white',
                'border-color': '#3e7794',
                'background-image': 'images/person100.png',
            })
            .selector('.eater')
            .css({
                'border-width': 9
            }),

        elements: elesJson,


        /* *********************** */
        /* Impostazioni del layout */
        /* *********************** */

        layout: {
            name: 'arbor',
            animate: true, // whether to show the layout as it's running
            maxSimulationTime: 4000, // max length in ms to run the layout
            fit: false, // on every layout reposition of nodes, fit the viewport
            padding: -2000, // padding around the simulation
            boundingBox: undefined, // constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
            ungrabifyWhileSimulating: false, // so you can't drag nodes during layout
            ready: function () {
                jQuery('.loader').fadeOut(300);
                jQuery('#cy2 canvas, #legenda').fadeIn(600);
                cy.zoom(0.6);
            }, // on layoutready
            stop: function () {

            }, // on layoutstop
            // forces used by arbor (use arbor default on undefined)
            repulsion: 30,
            stiffness: undefined,
            friction: 0.8,
            gravity: false,
            fps: undefined,
            dt: 0.01,
            precision: undefined,
            // static numbers or functions that dynamically return what these
            // values should be for each element
            // e.g. nodeMass: function(n){ return n.data('weight') }
            nodeMass: function (n) {
                return 0.3
            },
            edgeLength: function (data) {
                //					console.log(data.length);
                return data.length; // use the weight attribute in the edge data as length
            },
            stepSize: 0.1, // smoothing of arbor bounding box
            // function that returns true if the system is stable to indicate
            // that the layout can be stopped
            stableEnergy: function (energy) {
                var e = energy;
                return (e.max <= 0.5) || (e.mean <= 0.3);
            },
            // infinite layout options
            infinite: true // overrides all other options for a forces-all-the-time mode
        },
    });

    cy.panzoom({});

    crea_menu();
}

function crea_menu() {

    cy.batch(function () {
        var nodi = cy.$('node');

        jQuery.each(nodi, function (key, value) {

            var ID = value.id(),

                link = value.data('open'),
                link_name = value.data('open_name');
            link_url = urlPrefixNodeMenu + value.data('open_url');

            citation = value.data('citation');
            citation_label = value.data('citation_label');
            citattion_array = value.data('citattion_array');


            cy.$('#' + ID).qtip({
                content: value.data('tooltip'),
                position: {
                    target: 'mouse', // Position it where the click was...
                    adjust: {
                        mouse: false
                    } // ...but don't follow the mouse
                }
            });


            var arrayMenu = new Array();
            if (link == 'true') {
                arrayMenu.push({
                    /* LINK */
                    'content': link_name,
                    'select': function (data) {
                        window.open(this.data('open_url'));
                    },
                    'functions': 'link'
                });
            }
            if (citation == 'true') {
                arrayMenu.push({
                    /* citation */
                    'content': citation_label,
                    'select': function (data) {
                        citAttuale = 0;
                        citAttualeArray = this.data('citattion_array');
                        citTypeAttyale = this.data('nodeType');
                        citLabelAttyale = this.data('label');
                        selectCitation(this.data('citattion_array'), this.data('nodeType'));
                    },
                    'functions': 'citation'
                });
            }

            ID_nodo = '#' + ID;
            if (array_menu_creati.indexOf(ID_nodo) >= 0) { } else {
                array_menu_creati.push(ID_nodo);
                var cxtmenuGraph = cy.cxtmenu({
                    selector: ID_nodo,
                    commands: arrayMenu
                });
            }
        });
    });
}

function Add(JsonAttuale, tipo_cliccato, ID_nodo_cliccato) {

}

function selectCitation(citation_array, type) {

    document.getElementById("citationManager").innerHTML = "Citation " + (citAttuale + 1) + " di " + citation_array.length
    var citation = citation_array[citAttuale];
    var start = citation.start;
    var end = citation.end;
    highlightText(document.getElementById("textDiv"), start, end, type)
}

function highlightText(element, start, end, type) {

    element.innerHTML = inputText;
    var styleClass = "";
    if (type == "Soggetto Fisico") {
        styleClass = "highlightGPE";
    }
    if (type == "Luogo") {
        styleClass = "highlightGEO"
    }
    var str = element.innerHTML;
    str = str.substr(0, start) +
        '<span class="' + styleClass + '">' +
        str.substr(start, end - start + 1) +
        '</span>' +
        str.substr(end + 1);
    element.innerHTML = str;
}

function incrementCitation() {

    if (citAttualeArray.length >= citAttuale + 2) {
        citAttuale = citAttuale + 1;
        selectCitation(citAttualeArray, citTypeAttyale);
    } else {
        alert(" No Citation ");
    }
}

function decrementCitation() {

    if (citAttuale > 0) {
        citAttuale = citAttuale - 1;
        selectCitation(citAttualeArray, citTypeAttyale)
    } else {
        alert(" No Citation ");
    }
}

function allCitation() {

    if (citAttualeArray.length > 0) {

        var res = "";
        document.getElementById("textDiv").innerHTML = inputText;
        var testoVero = inputText;

        for (var j = citAttualeArray.length - 1; j >= 0; j--) {

            var start = citAttualeArray[j].start;
            var end = citAttualeArray[j].end;

            //console.log(start, end);
            testoVero = inputText
            highlightAllText(testoVero, document.getElementById("textDiv"), start, end, citTypeAttyale);

        }


    } else {
        alert(" No Citation ");
    }

}

function highlightAllText(testoVero, element, start, end, type) {


    var styleClass = "";
    if (type == "Soggetto Fisico") {
        styleClass = "highlightGPE";
    }
    if (type == "Luogo") {
        styleClass = "highlightGEO"
    }

    //var textTt = testoVero.substring(start, end);
    //console.log(textTt)
    // '<span class="' + styleClass + '">' + testoVero.substring(start, end) + '</span>' 
    var str = element.innerHTML;
    str = str.substr(0, start) +
        '<span class="' + styleClass + '">' +
        str.substr(start, end - start + 1) +
        '</span>' +
        str.substr(end + 1);
    element.innerHTML = str;


}	